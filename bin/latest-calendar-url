#!/usr/bin/php
<?php
declare(strict_types=1);

const LATEST_RELEASE_URL = 'https://api.github.com/repos/sportclimbing/ifsc-calendar/releases/latest';

$context = stream_context_create([
    'http' => [
        'method' => "GET",
        'header' =>
            "Accept-language: en\r\n" .
            "Accept: */*\r\n" .
            "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/111.0\r\n"
    ]
]);

$response = @file_get_contents(LATEST_RELEASE_URL, context: $context);

if (!$response) {
    echo "Unable to get response from API", PHP_EOL;
    exit(1);
}

try {
    $json = json_decode($response, flags: JSON_THROW_ON_ERROR);
} catch (JsonException $e) {
    echo "Unable to parse JSON: {$e->getMessage()}", PHP_EOL;
    exit(1);
}

if (!isset($json->assets[1]->browser_download_url)) {
    echo "Could not find asset", PHP_EOL;
    exit(1);
}

echo $json->assets[1]->browser_download_url;
